{
  "hash": "10bd29fb3209bb94973aa668d7022de7",
  "result": {
    "markdown": "---\ntitle: \"쮸 qui칠n le compra m치s el Estado?\"\ndescription: \"Uso datos abiertos de compras p칰blicas para averiguar los proveedores top en tratos directos.\"\nauthor: \"Paulo Villarroel\"\ndate: \"2022-10-15\"\ncategories: [tutorial, r, datos abiertos]\nimage: \"public.jpg\"\n---\n\n\nHola!!\n\n쯊e gustar칤a aprender a usar datos abiertos de compras p칰blicas (Chile) y realizar este lindo gr치fico?\n\n![](plot.png){fig-align=\"center\" width=\"800\"}\n\nPues bueno, ac치 te ense침o paso a paso.\n\nAh! No voy a realizar juicios de valor sobre los resultados. El fin de este art칤culo es mostrar una forma de usar datos abiertos y utilizando programaci칩n, realizar un breve an치lisis de consolidaci칩n de los datos y realizar el gr치fico.\n\nDicho eso, pero sin dejar de mencionar que llama la atenci칩n los 3 primeros proveedores a los cuales se le ha comprado m치s jajaja 游땍, vamos con el tema.\n\n## Los datos\n\nEl objetivo es investigar qu칠 proveedores son los m치s top en adjudicarse 칩rdenes de compra en salud.\n\nPara ello, usaremos los datos abiertos disponibles en la [plataforma de ChileCompra](https://datos-abiertos.chilecompra.cl/).\n\nEsta web es interesante, pues contiene los datos de todas las compras p칰blicas desde hace muchos a침os hasta la fecha, que se han realizado por medio de [Mercado P칰blico](https://www.mercadopublico.cl/Home). Por fines de investigaci칩n, siempre es una buena idea indagar en qu칠 tipo de datos est치s disponibles y cuales no. Adem치s, de entender las distintas variables que contiene. Para eso, puedes revisar la [documentaci칩n](https://datos-abiertos.chilecompra.cl/datos-abiertos) que el mismo sitio posee.\n\nOk. Partamos! 游땙\n\nCargamos las librerias de R que usaremos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(archive)\nlibrary(data.table)\nlibrary(lubridate)\nlibrary(hrbrthemes)\n```\n:::\n\n\nVamos a utilizar la descripci칩n que sale en la documentaci칩n sobre el uso de URL췂s para la descarga de los archivos.\n\nExiste la posibilidad de usar una API, pero requiere de un registro previo que no tengo, por lo cual no usar칠 esa opci칩n. Sin embargo, esa ser칤a la opci칩n ideal para nuestro caso.\n\n![](urls.png){fig-align=\"center\" width=\"800\"}\n\nBasado en el ejemplo, como deseo descargar los datos de las 칩rdenes de compra de salud habr칤a que tener construir un link similar a *https://chc-oc-files.s3.amazonaws.com/sector/2020/Sem1/Salud.7z*\n\nConstruyamos un peque침o loop para generar las URL췂s necesarias para la descarga de los datos.\n\nEn la plataforma hay registros para los a침os 2007 al 2022, separados por semestres en cada caso. Pero para efectos de este art칤culo solo descargar칠 desde el a침o 2017 en adelante.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntotal_url <- list()\n\nyear <- as.character(2017:2022)\n\nfor (i in year) {\n  url_sem1 <- paste0(\"https://chc-oc-files.s3.amazonaws.com/sector/\", i, \"/Sem1/Salud.7z\")\n  url_sem2 <- paste0(\"https://chc-oc-files.s3.amazonaws.com/sector/\", i, \"/Sem2/Salud.7z\")\n\n  total_url[[i]] <- c(url_sem1, url_sem2)\n}\n```\n:::\n\n\nVeamos las URL췂s:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurls <- unlist(total_url, use.names = FALSE)\nurls\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"https://chc-oc-files.s3.amazonaws.com/sector/2017/Sem1/Salud.7z\"\n [2] \"https://chc-oc-files.s3.amazonaws.com/sector/2017/Sem2/Salud.7z\"\n [3] \"https://chc-oc-files.s3.amazonaws.com/sector/2018/Sem1/Salud.7z\"\n [4] \"https://chc-oc-files.s3.amazonaws.com/sector/2018/Sem2/Salud.7z\"\n [5] \"https://chc-oc-files.s3.amazonaws.com/sector/2019/Sem1/Salud.7z\"\n [6] \"https://chc-oc-files.s3.amazonaws.com/sector/2019/Sem2/Salud.7z\"\n [7] \"https://chc-oc-files.s3.amazonaws.com/sector/2020/Sem1/Salud.7z\"\n [8] \"https://chc-oc-files.s3.amazonaws.com/sector/2020/Sem2/Salud.7z\"\n [9] \"https://chc-oc-files.s3.amazonaws.com/sector/2021/Sem1/Salud.7z\"\n[10] \"https://chc-oc-files.s3.amazonaws.com/sector/2021/Sem2/Salud.7z\"\n[11] \"https://chc-oc-files.s3.amazonaws.com/sector/2022/Sem1/Salud.7z\"\n[12] \"https://chc-oc-files.s3.amazonaws.com/sector/2022/Sem2/Salud.7z\"\n```\n:::\n:::\n\n\nMuy bien!! Nos qued칩 genial!\n\nAhora nos toca descargar los archivos desde esas direcciones web.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (i in 1:length(urls)) {\n  destfile <- paste0(here::here(), \"/data/\", i, \".7z\")\n  url <- urls[i]\n  download.file(url, destfile, mode = \"wb\")\n}\n```\n:::\n\n\nLos archivos tambi칠n pueden descargarse desde la misma plataforma sin necesidad de usar estas URL췂s, sino que por medio de la [propia interfaz](https://datos-abiertos.chilecompra.cl/descargas/ordenes-y-licitaciones) de Mercado P칰blico. Sin embargo, me parece mejor idea el usar c칩digo para automatizar esas tareas para as칤 evitar errores manuales y facilitar la descarga de nuevos archivos en un futuro.\n\nF칤jate que los archivos vienen comprimidos en un formato 7z.\n\nSi abrimos un archivo, nos encontraremos con otros 3 칩 4 en su interior:\n\n-   Convenio marco\n\n-   Licitaciones\n\n-   Trato directo\n\n-   Compra 치gil\n\nEn mi caso, me interesa indagar en los tratos directos.\n\n쮼l motivo?\n\nMe parecen m치s interesantes esos datos, puesto que hay gran variedad de compras y es en esta modalidad de compra en donde, muchas veces, se presta para fraude o problemas de legitimidad. Aunque con este art칤culo no pretendo realizar un an치lisis de ese estilo, podr칤a ser de inter칠s para alguien m치s y ocuparlo como base para fines de investigaci칩n.\n\nA continuaci칩n realizar칠 algunos loops para automatizar la extracci칩n de los datos.\n\nCabe mencionar que se podr칤a hacer en menos lineas de c칩digo, pero prefiero dejarlo as칤 para que te sea m치s simple de seguir el paso a paso.\n\nPara la funci칩n de extracci칩n (descomprimir) de m치s abajo, necesitamos ponerle nombres de los archivos 7z para pas치rselo a la funci칩n `archive_extract()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfiles_zipped <- list()\n\nfor (i in 1:length(urls)) {\n  file_name_zip <- paste0(\"data/\", i, \".7z\")\n  files_zipped[[i]] <- file_name_zip\n}\n\nfiles_zipped <- unlist(files_zipped, use.names = FALSE)\n\nfiles_zipped\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"data/1.7z\"  \"data/2.7z\"  \"data/3.7z\"  \"data/4.7z\"  \"data/5.7z\" \n [6] \"data/6.7z\"  \"data/7.7z\"  \"data/8.7z\"  \"data/9.7z\"  \"data/10.7z\"\n[11] \"data/11.7z\" \"data/12.7z\"\n```\n:::\n:::\n\n\nLos archivos de los ultimos 2 a침os son diferentes a los anteriores y el nombre del archivo comprimido es distinto. Para resolver eso, implement칠 un `if()`, seg칰n qu칠 archivo sea.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhere::i_am(\"index.qmd\")\n\noc <- list()\n\nfor (i in files_zipped) {\n  archive_extract(archive = i, dir = \"data\")\n\n  if (file.exists(\"data/17TratoDirecto.csv\")) {\n    oc[[i]] <- fread(\"data/17TratoDirecto.csv\", encoding = \"Latin-1\")\n  } else {\n    oc[[i]] <- fread(\"data/17OCTratoDirecto.csv\", encoding = \"Latin-1\")\n  }\n}\n```\n:::\n\n\nAhora pasamos el objeto que nos hab칤amos creado a un `data.frame` y lo \"aplanamos\" para no tener problemas despu칠s con los an치lisis. Para lo 칰ltimo, usamos `unnest()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_data <- rbindlist(oc) |> \n  unnest(cols = c())\n```\n:::\n\n\nVeamos todas las variables que contiene el archivo.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(all_data) #Filas y Columnas\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1429423      44\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(all_data) #Nombre de variables\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"codigoOC\"               \"FechaEnvioOC\"           \"NombreOC\"              \n [4] \"DescripcionOC\"          \"EstadoOC\"               \"ProcedenciaOC\"         \n [7] \"MonedaOC\"               \"MontoNetoOC\"            \"DescuentosOC\"          \n[10] \"CargosOC\"               \"ImpuestosOC\"            \"MontoTotalOC\"          \n[13] \"ImpuestosOC_CLP\"        \"MontoNetoOC_CLP\"        \"MetodoPago\"            \n[16] \"TipoDespacho\"           \"Financiamiento\"         \"UnidadCompra\"          \n[19] \"UnidadCompraRUT\"        \"RegionUnidadCompra\"     \"entCode\"               \n[22] \"Institucion\"            \"Sector\"                 \"Proveedor\"             \n[25] \"ProveedorRUT\"           \"ActividadProveedor\"     \"TamanoProveedor\"       \n[28] \"RegionProveedor\"        \"RubroN1\"                \"RubroN2\"               \n[31] \"RubroN3\"                \"CodigoProductoONU\"      \"ONUProducto\"           \n[34] \"NombreItem\"             \"DescripcionItem\"        \"CantidadItem\"          \n[37] \"UnidadMedida\"           \"MonedaItem\"             \"MontoNetoItem\"         \n[40] \"DescuentoItem\"          \"CargosItem\"             \"ImpuestoEspecificoItem\"\n[43] \"MontoTotalItem\"         \"MontoNetoItemCLP\"      \n```\n:::\n:::\n\n\n**Importante**\n\nLos archivos descargados son grandes y cuando se descrompimen, los son mucho m치s! Algunos llegan a pesar m치s de 200 o 300 Mb. De hecho, el objeto con todos los datos combinados sobrepasa 1 GB y tiene casi 1 mill칩n y medio de filas. Con un Excel no podr치s abrirlo, pues supera su l칤mite. Por eso es importante usar programaci칩n. Otra instancia ser칤a levantar un servidor SQL y cargar los datos, pero me parece que no vale la pena paa estos efectos.\n\nComo los archivos descargados son bastante grandes, es mejor borrarlos, pues ya tenemos lo que necesitamos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunlink(here::here(\"data/*\"), recursive = TRUE, force = TRUE)\n```\n:::\n\n\n## An치lisis\n\nVoy a considerar s칩lo las 칩rdenes de compra (OC) en estados de **recepci칩n conforme** y **aceptadas**. Esta es una decisi칩n que tom칠 en base a lo que se menciona en el portal, en especial, a los [est치ndares OCDS](https://desarrolladores.mercadopublico.cl/ocds/descripcion).\n\nEstos est치ndares permiten tener un lenguaje com칰n sobre el estado de las OC y un formato estructurado que facilite la revisi칩n, comprensi칩n y consumo de los datos.\n\nLa decisi칩n de usar solo esas etapas es m치s que nada para sacar del an치lisis todas aquellas OC que fueron rechazadas, tienen observaciones o sufrieron modificaciones en el camino. La idea es dejar aquellas efectivamente ejecutadas o que si bien a칰n no ocurren, ya fueron aceptadas por las partes.\n\n![](ocds.png){fig-align=\"center\" width=\"800\"}\n\nAlgo que me parece interesante de observar, es el gasto asociado a esas OC durante los a침os analizados.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppliers <- all_data |>\n  filter(EstadoOC %in% c(\"Recepcion Conforme\", \"Aceptada\")) |>\n  separate(FechaEnvioOC, into = c(\"Fecha\", \"Hora\"), sep = \" \", remove = TRUE) |>\n  mutate(Fecha = dmy(Fecha)) |>\n  group_by(Proveedor, year = year(Fecha)) |>\n  summarise(mount = sum(as.numeric(MontoTotalItem), na.rm = TRUE)) |>\n  ungroup()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppliers |>\n  group_by(year) |>\n  summarise(mount = sum(mount, na.rm = TRUE)) |>\n  ggplot(aes(year, mount)) +\n  geom_col() +\n  scale_y_continuous(labels = scales::comma) +\n  scale_x_continuous(breaks = c(2017, 2018, 2019, 2020, 2021, 2022)) +\n  theme_bw() +\n  labs(\n    x = \"A침o\",\n    y = \"Monto Total OC ($)\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nVemos que en los a침os 2022 y 2021 los montos asociados a este tipo de OC aumentario de forma considerable respecto de los a침os anteriores. Posiblemente, eso tenga mucha relaci칩n con la pandemia y la necesidad de contar r치pidamente con insumos, medicamentos, infraestructura, personal, ex치menes y muchas otras cosas.\n\nSi vemos los proveedores, podemos hace un r치nking de 칠stos y revisar cu치les fueron los 5 de cada a침o que tuvieron mayores cantidades de transacciones por OC:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop5_by_year <- suppliers |>\n  mutate(Proveedor = str_to_upper(Proveedor)) |>\n  arrange(desc(mount)) |>\n  group_by(year) |>\n  do(head(., 5)) |>\n  ungroup()\n\ntop5_by_year |>\n  DT::datatable()\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-60be6cc602097fbd753d\" style=\"width:100%;height:auto;\" class=\"datatables html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-60be6cc602097fbd753d\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\"],[\"ROCHE CHILE LIMITADA\",\"INDUSTRIAS PRODUCTOS ALIMENTICIOS SA\",\"GLAXOSMITHKLINE CHILE FARMACEUTICA LIMITADA\",\"BRISTOL MYERS SQUIBB DE CHILE AGENC DE E R SQUIBB &amp; SONS INTERAM CORPO\",\"MERCK SHARP &amp; DOHME (I.A) LLC,AGENCIA EN CHILE\",\"GLAXOSMITHKLINE CHILE FARMACEUTICA LIMITADA\",\"ROCHE CHILE LIMITADA\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"MERCK SHARP &amp; DOHME (I.A) LLC,AGENCIA EN CHILE\",\"GADOR LIMITADA\",\"LABORATORIOS WYETH LLC\",\"MERCK SHARP &amp; DOHME (I.A) LLC,AGENCIA EN CHILE\",\"PFIZER CHILE S.A.\",\"GLAXOSMITHKLINE CHILE FARMACEUTICA LIMITADA\",\"ROCHE CHILE LIMITADA\",\"ROCHE CHILE LIMITADA\",\"GADOR LIMITADA\",\"ABBVIE PRODUCTOS FARMACEUTICOS LIMITADA\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"BRISTOL MYERS SQUIBB DE CHILE AGENC DE E R SQUIBB &amp; SONS INTERAM CORPO\",\"ROCHE CHILE LIMITADA\",\"DISTRIBUIDORA COMERCIAL PHARMASAN LIMITADA\",\"PONTIFICIA UNIVERSIDAD CATOLICA DE CHILE\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"LIFE TECHNOLOGIES CHILE SPA\",\"ROCHE CHILE LIMITADA\",\"PONTIFICIA UNIVERSIDAD CATOLICA DE CHILE\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"TAAG GENETICS S A\",\"ABBVIE PRODUCTOS FARMACEUTICOS LIMITADA\"],[2017,2017,2017,2017,2017,2018,2018,2018,2018,2018,2019,2019,2019,2019,2019,2020,2020,2020,2020,2020,2021,2021,2021,2021,2021,2022,2022,2022,2022,2022],[23472392330,12580689400,11094784057,11089615855,10378399603,43946033497,37337502964,21405586200,21305849074,16744909040,25633073604,23353789302,18223404173,17686761539,17569893778,68286503812,35373547142,34809477443,24461850251,22741202358,71001268998,47751190300,24302057844,22314550472,21635827237,30693294568,22647393719,21942469022,21249113297,18497016066]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Proveedor<\\/th>\\n      <th>year<\\/th>\\n      <th>mount<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nSi tienes inter칠s en profundizar en el tema, ya tienes todo lo necesario. Tienes los datos y el c칩digo para replicarlo. Puedes seguir investigando los registros, de seguro hay cosas entretenidas. Quiz치s quieras dirigir el an치lisis a un proveedor en espec칤fico o a una instituci칩n p칰blica en especial. La verdad, no hay l칤mites. Solo tu curiosidad e imaginaci칩n.\n\n## Gr치fico\n\nPodemos graficarlo para ver mejor esos datos y analizar el comportamiento a lo largo de los a침os de los proveedores con m치s montos en OC.\n\nPara eso usaremos la famosa libreria `ggplot2` con algunos agregados para hacer el gr치fico m치s atractivo.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot <- top5_by_year |>\n  mutate(Proveedor = fct_reorder(Proveedor, mount, .fun = \"sum\"),\n         mount_mill = mount/1e6) |> \n  ggplot(aes(Proveedor, mount_mill, fill = factor(year))) +\n  geom_col(position = \"stack\") +\n  coord_flip() +\n  scale_y_continuous(labels = scales::comma) +\n  expand_limits( y = c(0, 250000)) +\n  labs(title = \"Compras p칰blicas por trato directo en el sector salud\",\n       subtitle = \"Se consideran las OC con estados de recepci칩n conforme y aceptadas\",\n       x = \"\",\n       y = \"Millones de pesos ($)\",\n       fill = \"A침o\",\n       caption = \"Fuente: ChileCompra (https://datos-abiertos.chilecompra.cl)\\nElaborado por Paulo Villarroel\") +\n  theme_ipsum_rc(grid = \"XY\") +\n  theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1)))\n```\n:::\n\n\n![](plot.png){fig-align=\"center\" width=\"800\"}\n\nSi quieres ver la imagen m치s grande, dale al boton derecho y abrir en nueva ventena.\n\nSi, Si. Es el mismo gr치fico del inicio 游봃\n\nListo!!\n\n## Finalmente\n\nEspero que te haya gustado este art칤culo. Trat칠 de ser lo m치s explicativo posible. Adem치s, de dejarte el paso a paso para que tu sigas adelante.\n\nLos datos abiertos son una muy buena oportunidad para que la ciudadan칤a pueda realizar fiscalizaci칩n y auditoria al funcionamiento de los organismos p칰blicos. Eso si, se requiere de ciertos conocimientos para saber d칩nde encontrar esos datos y para poder analizarlos. Es mi deseo que este art칤culo te sea de ayuda, despierte tu curiosidad y seamos agentes de divulgaci칩n cient칤fica de cara a la gente.\n\nNos vemos!!\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.5.4/htmlwidgets.js\"></script>\r\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/datatables-binding-0.23/datatables.js\"></script>\r\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\r\n<link href=\"../../site_libs/dt-core-1.11.3/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\r\n<link href=\"../../site_libs/dt-core-1.11.3/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/dt-core-1.11.3/js/jquery.dataTables.min.js\"></script>\r\n<link href=\"../../site_libs/crosstalk-1.2.0/css/crosstalk.min.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/crosstalk-1.2.0/js/crosstalk.min.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}