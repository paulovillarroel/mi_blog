{
  "hash": "10bd29fb3209bb94973aa668d7022de7",
  "result": {
    "markdown": "---\ntitle: \"¿A quién le compra más el Estado?\"\ndescription: \"Uso datos abiertos de compras públicas para averiguar los proveedores top en tratos directos.\"\nauthor: \"Paulo Villarroel\"\ndate: \"2022-10-15\"\ncategories: [tutorial, r, datos abiertos]\nimage: \"public.jpg\"\n---\n\n\nHola!!\n\n¿Te gustaría aprender a usar datos abiertos de compras públicas (Chile) y realizar este lindo gráfico?\n\n![](plot.png){fig-align=\"center\" width=\"800\"}\n\nPues bueno, acá te enseño paso a paso.\n\nAh! No voy a realizar juicios de valor sobre los resultados. El fin de este artículo es mostrar una forma de usar datos abiertos y utilizando programación, realizar un breve análisis de consolidación de los datos y realizar el gráfico.\n\nDicho eso, pero sin dejar de mencionar que llama la atención los 3 primeros proveedores a los cuales se le ha comprado más jajaja 😂, vamos con el tema.\n\n## Los datos\n\nEl objetivo es investigar qué proveedores son los más top en adjudicarse órdenes de compra en salud.\n\nPara ello, usaremos los datos abiertos disponibles en la [plataforma de ChileCompra](https://datos-abiertos.chilecompra.cl/).\n\nEsta web es interesante, pues contiene los datos de todas las compras públicas desde hace muchos años hasta la fecha, que se han realizado por medio de [Mercado Público](https://www.mercadopublico.cl/Home). Por fines de investigación, siempre es una buena idea indagar en qué tipo de datos estás disponibles y cuales no. Además, de entender las distintas variables que contiene. Para eso, puedes revisar la [documentación](https://datos-abiertos.chilecompra.cl/datos-abiertos) que el mismo sitio posee.\n\nOk. Partamos! 😎\n\nCargamos las librerias de R que usaremos:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(archive)\nlibrary(data.table)\nlibrary(lubridate)\nlibrary(hrbrthemes)\n```\n:::\n\n\nVamos a utilizar la descripción que sale en la documentación sobre el uso de URL´s para la descarga de los archivos.\n\nExiste la posibilidad de usar una API, pero requiere de un registro previo que no tengo, por lo cual no usaré esa opción. Sin embargo, esa sería la opción ideal para nuestro caso.\n\n![](urls.png){fig-align=\"center\" width=\"800\"}\n\nBasado en el ejemplo, como deseo descargar los datos de las órdenes de compra de salud habría que tener construir un link similar a *https://chc-oc-files.s3.amazonaws.com/sector/2020/Sem1/Salud.7z*\n\nConstruyamos un pequeño loop para generar las URL´s necesarias para la descarga de los datos.\n\nEn la plataforma hay registros para los años 2007 al 2022, separados por semestres en cada caso. Pero para efectos de este artículo solo descargaré desde el año 2017 en adelante.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntotal_url <- list()\n\nyear <- as.character(2017:2022)\n\nfor (i in year) {\n  url_sem1 <- paste0(\"https://chc-oc-files.s3.amazonaws.com/sector/\", i, \"/Sem1/Salud.7z\")\n  url_sem2 <- paste0(\"https://chc-oc-files.s3.amazonaws.com/sector/\", i, \"/Sem2/Salud.7z\")\n\n  total_url[[i]] <- c(url_sem1, url_sem2)\n}\n```\n:::\n\n\nVeamos las URL´s:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurls <- unlist(total_url, use.names = FALSE)\nurls\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"https://chc-oc-files.s3.amazonaws.com/sector/2017/Sem1/Salud.7z\"\n [2] \"https://chc-oc-files.s3.amazonaws.com/sector/2017/Sem2/Salud.7z\"\n [3] \"https://chc-oc-files.s3.amazonaws.com/sector/2018/Sem1/Salud.7z\"\n [4] \"https://chc-oc-files.s3.amazonaws.com/sector/2018/Sem2/Salud.7z\"\n [5] \"https://chc-oc-files.s3.amazonaws.com/sector/2019/Sem1/Salud.7z\"\n [6] \"https://chc-oc-files.s3.amazonaws.com/sector/2019/Sem2/Salud.7z\"\n [7] \"https://chc-oc-files.s3.amazonaws.com/sector/2020/Sem1/Salud.7z\"\n [8] \"https://chc-oc-files.s3.amazonaws.com/sector/2020/Sem2/Salud.7z\"\n [9] \"https://chc-oc-files.s3.amazonaws.com/sector/2021/Sem1/Salud.7z\"\n[10] \"https://chc-oc-files.s3.amazonaws.com/sector/2021/Sem2/Salud.7z\"\n[11] \"https://chc-oc-files.s3.amazonaws.com/sector/2022/Sem1/Salud.7z\"\n[12] \"https://chc-oc-files.s3.amazonaws.com/sector/2022/Sem2/Salud.7z\"\n```\n:::\n:::\n\n\nMuy bien!! Nos quedó genial!\n\nAhora nos toca descargar los archivos desde esas direcciones web.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfor (i in 1:length(urls)) {\n  destfile <- paste0(here::here(), \"/data/\", i, \".7z\")\n  url <- urls[i]\n  download.file(url, destfile, mode = \"wb\")\n}\n```\n:::\n\n\nLos archivos también pueden descargarse desde la misma plataforma sin necesidad de usar estas URL´s, sino que por medio de la [propia interfaz](https://datos-abiertos.chilecompra.cl/descargas/ordenes-y-licitaciones) de Mercado Público. Sin embargo, me parece mejor idea el usar código para automatizar esas tareas para así evitar errores manuales y facilitar la descarga de nuevos archivos en un futuro.\n\nFíjate que los archivos vienen comprimidos en un formato 7z.\n\nSi abrimos un archivo, nos encontraremos con otros 3 ó 4 en su interior:\n\n-   Convenio marco\n\n-   Licitaciones\n\n-   Trato directo\n\n-   Compra ágil\n\nEn mi caso, me interesa indagar en los tratos directos.\n\n¿El motivo?\n\nMe parecen más interesantes esos datos, puesto que hay gran variedad de compras y es en esta modalidad de compra en donde, muchas veces, se presta para fraude o problemas de legitimidad. Aunque con este artículo no pretendo realizar un análisis de ese estilo, podría ser de interés para alguien más y ocuparlo como base para fines de investigación.\n\nA continuación realizaré algunos loops para automatizar la extracción de los datos.\n\nCabe mencionar que se podría hacer en menos lineas de código, pero prefiero dejarlo así para que te sea más simple de seguir el paso a paso.\n\nPara la función de extracción (descomprimir) de más abajo, necesitamos ponerle nombres de los archivos 7z para pasárselo a la función `archive_extract()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfiles_zipped <- list()\n\nfor (i in 1:length(urls)) {\n  file_name_zip <- paste0(\"data/\", i, \".7z\")\n  files_zipped[[i]] <- file_name_zip\n}\n\nfiles_zipped <- unlist(files_zipped, use.names = FALSE)\n\nfiles_zipped\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"data/1.7z\"  \"data/2.7z\"  \"data/3.7z\"  \"data/4.7z\"  \"data/5.7z\" \n [6] \"data/6.7z\"  \"data/7.7z\"  \"data/8.7z\"  \"data/9.7z\"  \"data/10.7z\"\n[11] \"data/11.7z\" \"data/12.7z\"\n```\n:::\n:::\n\n\nLos archivos de los ultimos 2 años son diferentes a los anteriores y el nombre del archivo comprimido es distinto. Para resolver eso, implementé un `if()`, según qué archivo sea.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhere::i_am(\"index.qmd\")\n\noc <- list()\n\nfor (i in files_zipped) {\n  archive_extract(archive = i, dir = \"data\")\n\n  if (file.exists(\"data/17TratoDirecto.csv\")) {\n    oc[[i]] <- fread(\"data/17TratoDirecto.csv\", encoding = \"Latin-1\")\n  } else {\n    oc[[i]] <- fread(\"data/17OCTratoDirecto.csv\", encoding = \"Latin-1\")\n  }\n}\n```\n:::\n\n\nAhora pasamos el objeto que nos habíamos creado a un `data.frame` y lo \"aplanamos\" para no tener problemas después con los análisis. Para lo último, usamos `unnest()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nall_data <- rbindlist(oc) |> \n  unnest(cols = c())\n```\n:::\n\n\nVeamos todas las variables que contiene el archivo.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(all_data) #Filas y Columnas\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1429423      44\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(all_data) #Nombre de variables\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"codigoOC\"               \"FechaEnvioOC\"           \"NombreOC\"              \n [4] \"DescripcionOC\"          \"EstadoOC\"               \"ProcedenciaOC\"         \n [7] \"MonedaOC\"               \"MontoNetoOC\"            \"DescuentosOC\"          \n[10] \"CargosOC\"               \"ImpuestosOC\"            \"MontoTotalOC\"          \n[13] \"ImpuestosOC_CLP\"        \"MontoNetoOC_CLP\"        \"MetodoPago\"            \n[16] \"TipoDespacho\"           \"Financiamiento\"         \"UnidadCompra\"          \n[19] \"UnidadCompraRUT\"        \"RegionUnidadCompra\"     \"entCode\"               \n[22] \"Institucion\"            \"Sector\"                 \"Proveedor\"             \n[25] \"ProveedorRUT\"           \"ActividadProveedor\"     \"TamanoProveedor\"       \n[28] \"RegionProveedor\"        \"RubroN1\"                \"RubroN2\"               \n[31] \"RubroN3\"                \"CodigoProductoONU\"      \"ONUProducto\"           \n[34] \"NombreItem\"             \"DescripcionItem\"        \"CantidadItem\"          \n[37] \"UnidadMedida\"           \"MonedaItem\"             \"MontoNetoItem\"         \n[40] \"DescuentoItem\"          \"CargosItem\"             \"ImpuestoEspecificoItem\"\n[43] \"MontoTotalItem\"         \"MontoNetoItemCLP\"      \n```\n:::\n:::\n\n\n**Importante**\n\nLos archivos descargados son grandes y cuando se descrompimen, los son mucho más! Algunos llegan a pesar más de 200 o 300 Mb. De hecho, el objeto con todos los datos combinados sobrepasa 1 GB y tiene casi 1 millón y medio de filas. Con un Excel no podrás abrirlo, pues supera su límite. Por eso es importante usar programación. Otra instancia sería levantar un servidor SQL y cargar los datos, pero me parece que no vale la pena paa estos efectos.\n\nComo los archivos descargados son bastante grandes, es mejor borrarlos, pues ya tenemos lo que necesitamos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nunlink(here::here(\"data/*\"), recursive = TRUE, force = TRUE)\n```\n:::\n\n\n## Análisis\n\nVoy a considerar sólo las órdenes de compra (OC) en estados de **recepción conforme** y **aceptadas**. Esta es una decisión que tomé en base a lo que se menciona en el portal, en especial, a los [estándares OCDS](https://desarrolladores.mercadopublico.cl/ocds/descripcion).\n\nEstos estándares permiten tener un lenguaje común sobre el estado de las OC y un formato estructurado que facilite la revisión, comprensión y consumo de los datos.\n\nLa decisión de usar solo esas etapas es más que nada para sacar del análisis todas aquellas OC que fueron rechazadas, tienen observaciones o sufrieron modificaciones en el camino. La idea es dejar aquellas efectivamente ejecutadas o que si bien aún no ocurren, ya fueron aceptadas por las partes.\n\n![](ocds.png){fig-align=\"center\" width=\"800\"}\n\nAlgo que me parece interesante de observar, es el gasto asociado a esas OC durante los años analizados.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppliers <- all_data |>\n  filter(EstadoOC %in% c(\"Recepcion Conforme\", \"Aceptada\")) |>\n  separate(FechaEnvioOC, into = c(\"Fecha\", \"Hora\"), sep = \" \", remove = TRUE) |>\n  mutate(Fecha = dmy(Fecha)) |>\n  group_by(Proveedor, year = year(Fecha)) |>\n  summarise(mount = sum(as.numeric(MontoTotalItem), na.rm = TRUE)) |>\n  ungroup()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppliers |>\n  group_by(year) |>\n  summarise(mount = sum(mount, na.rm = TRUE)) |>\n  ggplot(aes(year, mount)) +\n  geom_col() +\n  scale_y_continuous(labels = scales::comma) +\n  scale_x_continuous(breaks = c(2017, 2018, 2019, 2020, 2021, 2022)) +\n  theme_bw() +\n  labs(\n    x = \"Año\",\n    y = \"Monto Total OC ($)\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nVemos que en los años 2022 y 2021 los montos asociados a este tipo de OC aumentario de forma considerable respecto de los años anteriores. Posiblemente, eso tenga mucha relación con la pandemia y la necesidad de contar rápidamente con insumos, medicamentos, infraestructura, personal, exámenes y muchas otras cosas.\n\nSi vemos los proveedores, podemos hace un ránking de éstos y revisar cuáles fueron los 5 de cada año que tuvieron mayores cantidades de transacciones por OC:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop5_by_year <- suppliers |>\n  mutate(Proveedor = str_to_upper(Proveedor)) |>\n  arrange(desc(mount)) |>\n  group_by(year) |>\n  do(head(., 5)) |>\n  ungroup()\n\ntop5_by_year |>\n  DT::datatable()\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-60be6cc602097fbd753d\" style=\"width:100%;height:auto;\" class=\"datatables html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-60be6cc602097fbd753d\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\"],[\"ROCHE CHILE LIMITADA\",\"INDUSTRIAS PRODUCTOS ALIMENTICIOS SA\",\"GLAXOSMITHKLINE CHILE FARMACEUTICA LIMITADA\",\"BRISTOL MYERS SQUIBB DE CHILE AGENC DE E R SQUIBB &amp; SONS INTERAM CORPO\",\"MERCK SHARP &amp; DOHME (I.A) LLC,AGENCIA EN CHILE\",\"GLAXOSMITHKLINE CHILE FARMACEUTICA LIMITADA\",\"ROCHE CHILE LIMITADA\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"MERCK SHARP &amp; DOHME (I.A) LLC,AGENCIA EN CHILE\",\"GADOR LIMITADA\",\"LABORATORIOS WYETH LLC\",\"MERCK SHARP &amp; DOHME (I.A) LLC,AGENCIA EN CHILE\",\"PFIZER CHILE S.A.\",\"GLAXOSMITHKLINE CHILE FARMACEUTICA LIMITADA\",\"ROCHE CHILE LIMITADA\",\"ROCHE CHILE LIMITADA\",\"GADOR LIMITADA\",\"ABBVIE PRODUCTOS FARMACEUTICOS LIMITADA\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"BRISTOL MYERS SQUIBB DE CHILE AGENC DE E R SQUIBB &amp; SONS INTERAM CORPO\",\"ROCHE CHILE LIMITADA\",\"DISTRIBUIDORA COMERCIAL PHARMASAN LIMITADA\",\"PONTIFICIA UNIVERSIDAD CATOLICA DE CHILE\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"LIFE TECHNOLOGIES CHILE SPA\",\"ROCHE CHILE LIMITADA\",\"PONTIFICIA UNIVERSIDAD CATOLICA DE CHILE\",\"JOHNSON Y JOHNSON DE CHILE S A\",\"TAAG GENETICS S A\",\"ABBVIE PRODUCTOS FARMACEUTICOS LIMITADA\"],[2017,2017,2017,2017,2017,2018,2018,2018,2018,2018,2019,2019,2019,2019,2019,2020,2020,2020,2020,2020,2021,2021,2021,2021,2021,2022,2022,2022,2022,2022],[23472392330,12580689400,11094784057,11089615855,10378399603,43946033497,37337502964,21405586200,21305849074,16744909040,25633073604,23353789302,18223404173,17686761539,17569893778,68286503812,35373547142,34809477443,24461850251,22741202358,71001268998,47751190300,24302057844,22314550472,21635827237,30693294568,22647393719,21942469022,21249113297,18497016066]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Proveedor<\\/th>\\n      <th>year<\\/th>\\n      <th>mount<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3]},{\"orderable\":false,\"targets\":0}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n\nSi tienes interés en profundizar en el tema, ya tienes todo lo necesario. Tienes los datos y el código para replicarlo. Puedes seguir investigando los registros, de seguro hay cosas entretenidas. Quizás quieras dirigir el análisis a un proveedor en específico o a una institución pública en especial. La verdad, no hay límites. Solo tu curiosidad e imaginación.\n\n## Gráfico\n\nPodemos graficarlo para ver mejor esos datos y analizar el comportamiento a lo largo de los años de los proveedores con más montos en OC.\n\nPara eso usaremos la famosa libreria `ggplot2` con algunos agregados para hacer el gráfico más atractivo.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot <- top5_by_year |>\n  mutate(Proveedor = fct_reorder(Proveedor, mount, .fun = \"sum\"),\n         mount_mill = mount/1e6) |> \n  ggplot(aes(Proveedor, mount_mill, fill = factor(year))) +\n  geom_col(position = \"stack\") +\n  coord_flip() +\n  scale_y_continuous(labels = scales::comma) +\n  expand_limits( y = c(0, 250000)) +\n  labs(title = \"Compras públicas por trato directo en el sector salud\",\n       subtitle = \"Se consideran las OC con estados de recepción conforme y aceptadas\",\n       x = \"\",\n       y = \"Millones de pesos ($)\",\n       fill = \"Año\",\n       caption = \"Fuente: ChileCompra (https://datos-abiertos.chilecompra.cl)\\nElaborado por Paulo Villarroel\") +\n  theme_ipsum_rc(grid = \"XY\") +\n  theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1)))\n```\n:::\n\n\n![](plot.png){fig-align=\"center\" width=\"800\"}\n\nSi quieres ver la imagen más grande, dale al boton derecho y abrir en nueva ventena.\n\nSi, Si. Es el mismo gráfico del inicio 🥰\n\nListo!!\n\n## Finalmente\n\nEspero que te haya gustado este artículo. Traté de ser lo más explicativo posible. Además, de dejarte el paso a paso para que tu sigas adelante.\n\nLos datos abiertos son una muy buena oportunidad para que la ciudadanía pueda realizar fiscalización y auditoria al funcionamiento de los organismos públicos. Eso si, se requiere de ciertos conocimientos para saber dónde encontrar esos datos y para poder analizarlos. Es mi deseo que este artículo te sea de ayuda, despierte tu curiosidad y seamos agentes de divulgación científica de cara a la gente.\n\nNos vemos!!\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.5.4/htmlwidgets.js\"></script>\r\n<link href=\"../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/datatables-binding-0.23/datatables.js\"></script>\r\n<script src=\"../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\r\n<link href=\"../../site_libs/dt-core-1.11.3/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\r\n<link href=\"../../site_libs/dt-core-1.11.3/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/dt-core-1.11.3/js/jquery.dataTables.min.js\"></script>\r\n<link href=\"../../site_libs/crosstalk-1.2.0/css/crosstalk.min.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/crosstalk-1.2.0/js/crosstalk.min.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}